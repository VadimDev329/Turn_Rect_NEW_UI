{"version":3,"sources":["file:///D:/ENGINES/Cocos/PROJECTS/103_2/387/ST/NEW/Rect/Turn_Rect_NEW/assets/resources/scripts/Game_Turn6.ts"],"names":["_decorator","Component","Node","rect","Label","resources","Sprite","SpriteFrame","math","UITransform","Layers","ccclass","property","Game","type","row","col","count","score","isGameOver","onLoad","load","err","image","console","error","cut_out4","schedule","_timer","sprf","imgSize","originalSize","rectW","width","rectH","height","i","j","piece","layer","Enum","UI_2D","ui","addComponent","setContentSize","sprite","frame","clone","spriteFrame","node","addChild","posX","posY","setPosition","angles","angle","randomRangeInt","on","EventType","TOUCH_START","onTouchStart","event","target","game_victory","log","timerLabel","string","game_over","_score","go","children","forEach","child","currentAngle","Math","round","abs","scoreX","game_state","stopGame","unschedule","off","onDestroy","unscheduleAllCallbacks"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Rect, rect, Label, resources, Sprite, SpriteFrame, math, EventTouch, UITransform, Layers } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Game')\r\nexport class Game extends Component {\r\n\r\n    @property({ type: Label }) public scoreX: Label | null = null;\r\n    @property({ type: Label }) public timerLabel: Label | null = null;\r\n    @property({ type: Label }) public game_state: Label | null = null;\r\n\r\n    private row: number = 6;\r\n    private col: number = 6;\r\n    private count: number = 80;\r\n    private score: number = 0;\r\n    private isGameOver: boolean = false;\r\n\r\n    onLoad() {\r\n        // Загрузка ресурсов\r\n        resources.load('images/110/spriteFrame', SpriteFrame, (err, image) => {\r\n            if (err) return console.error(err);\r\n            this.cut_out4(image);\r\n            this.schedule(this._timer, 1);\r\n        });\r\n    }\r\n\r\n    cut_out4(sprf: SpriteFrame) {\r\n        const imgSize = sprf.originalSize;\r\n        const rectW = imgSize.width / this.col;\r\n        const rectH = imgSize.height / this.row;\r\n\r\n        for (let i = 0; i < this.row; i++) {\r\n            for (let j = 0; j < this.col; j++) {\r\n                const piece = new Node(`Piece_${i}_${j}`);\r\n                piece.layer = Layers.Enum.UI_2D;\r\n\r\n                // 1. Добавляем UITransform (КРИТИЧНО для кликов в 3.x)\r\n                const ui = piece.addComponent(UITransform);\r\n                ui.setContentSize(rectW, rectH);\r\n\r\n                // 2. Спрайт\r\n                const sprite = piece.addComponent(Sprite);\r\n                const frame = sprf.clone();\r\n                frame.rect = rect(j * rectW, i * rectH, rectW, rectH);\r\n                sprite.spriteFrame = frame;\r\n\r\n                this.node.addChild(piece);\r\n\r\n                // 3. Позиция\r\n                const posX = j * rectW - imgSize.width / 2 + rectW / 2;\r\n                const posY = i * rectH - imgSize.height / 2 + rectH / 2;\r\n                piece.setPosition(posX, -posY, 0);\r\n\r\n                // 4. Рандомный поворот\r\n                const angles = [0, 90, 180, 270];\r\n                piece.angle = angles[math.randomRangeInt(0, 4)];\r\n\r\n                // 5. ПОДПИСЫВАЕМ КАЖДЫЙ КУСОЧИК (как в твоем рабочем коде)\r\n                piece.on(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver) return;\r\n\r\n        // В индивидуальной подписке target — это сам кубик\r\n        const target = event.target as Node;\r\n\r\n        target.angle += 90;\r\n        if (target.angle >= 360) target.angle = 0;\r\n\r\n        this.game_victory();\r\n    }\r\n\r\n    // --- Остальная логика без изменений ---\r\n\r\n    _timer() {\r\n        if (this.isGameOver) return;\r\n\r\n        this.count--;\r\n\r\n        // Проверяем через консоль, идет ли счет\r\n        console.log(\"Осталось времени:\", this.count);\r\n\r\n        if (this.timerLabel) {\r\n            this.timerLabel.string = \"TIME \" + this.count;\r\n        }\r\n\r\n        if (this.count <= 0) {\r\n            this.game_over();\r\n        }\r\n    }\r\n\r\n    _score() {\r\n        let go = 0;\r\n        this.node.children.forEach(child => {\r\n            // Используем Math.round, чтобы исключить микро-ошибки плавающей точки\r\n            let currentAngle = Math.round(child.angle) % 360;\r\n\r\n            // В JS % может вернуть -90, поэтому берем абсолютное значение\r\n            if (Math.abs(currentAngle) === 0) {\r\n                go++;\r\n            }\r\n        });\r\n\r\n        this.score = go;\r\n        console.log(\"Текущий счет:\", this.score, \"из\", this.col * this.row);\r\n\r\n        if (this.scoreX) {\r\n            this.scoreX.string = \"Score \" + this.score;\r\n        }\r\n    }\r\n\r\n    game_victory() {\r\n        this._score();\r\n        if (this.score === this.col * this.row) {\r\n            if (this.game_state) this.game_state.string = \"Victory!\";\r\n            this.stopGame();\r\n        }\r\n    }\r\n\r\n    game_over() {\r\n        if (this.game_state) this.game_state.string = \"Game Over\";\r\n        this.stopGame();\r\n    }\r\n\r\n    stopGame() {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n        // Снимаем слушателей с каждого ребенка\r\n        this.node.children.forEach(child => {\r\n            child.off(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        });\r\n    }\r\n\r\n    onDestroy() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}"]}