{"version":3,"sources":["file:///D:/ENGINES/Cocos/PROJECTS/103_2/387/ST/NEW/Rect/Turn_Rect_NEW_UI/assets/resources/scripts/Game.ts"],"names":["_decorator","Component","Node","Label","Sprite","SpriteFrame","math","UITransform","Layers","rect","tween","Vec3","Color","Enum","UIManager","ccclass","property","VictoryEffect","Game","type","tooltip","levels","rows","cols","time","maxClicks","penaltyTime","hasFreeze","hasSpinOut","currentLevelIdx","currentTime","isGameOver","score","countdownValue","onLoad","start","ui","switchWindow","startLevel","onWin","startNextLevel","length","onLevelSelectClick","event","levelIndex","idx","parseInt","isNaN","console","log","error","onRestartClick","config","timerLabel","string","scoreLabel","stateLabel","puzzleContainer","removeAllChildren","image","levelImages","setupGrid","startCountdown","unschedule","doCountdownTick","_timer","node","active","schedule","toString","setScale","to","scale","easing","scheduleOnce","sprf","imgSize","originalSize","rectW","width","rectH","height","i","j","piece","layer","UI_2D","addComponent","setContentSize","sprite","frame","clone","spriteFrame","addChild","posX","posY","setPosition","angles","angle","randomRangeInt","on","EventType","TOUCH_START","onTouchStart","target","applyPenalty","rotatePiece","rotationCount","Math","random","floor","targetAngle","call","round","_score","game_over","triggerPenaltyVisual","freezePiece","getComponent","grayscale","correctPieces","children","forEach","child","abs","totalPieces","victoryAnimation","useConfetti","spawnConfetti","pieces","index","delay","victoryEffect","SPIN_WAVE","by","BOUNCE_WAVE","originalPos","position","upPos","x","y","z","colors","RED","GREEN","BLUE","YELLOW","CYAN","MAGENTA","referenceSprite","getComponentInChildren","particle","color","parent","setSiblingIndex","destX","randomRange","destY","duration","destroy","bounceWaveAnimation","reason","WHITE","stopGame","off","penalty","originalColor","onDestroy","unscheduleAllCallbacks"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Label, resources, Sprite, SpriteFrame, math, EventTouch, UITransform, Layers, rect, tween, Vec3, Color, Enum } from 'cc';\r\nimport { UIManager } from \"./UIManager2\";\r\nconst { ccclass, property } = _decorator;\r\n\r\ninterface ILevel {\r\n    rows: number;\r\n    cols: number;\r\n    time: number;\r\n    maxClicks: number;\r\n    penaltyTime: number;\r\n    hasFreeze: boolean;\r\n    hasSpinOut: boolean;\r\n}\r\n\r\n// Создаем список доступных анимаций\r\nenum VictoryEffect {\r\n    SPIN_WAVE,   // Вращательная волна\r\n    BOUNCE_WAVE, // Прыгающая волна\r\n    NONE         // Без анимации\r\n}\r\n// Регистрируем Enum для инспектора\r\nEnum(VictoryEffect);\r\n\r\n@ccclass('Game')\r\nexport class Game extends Component {\r\n    // Убедись, что в Инспекторе привязаны эти три Label!\r\n    @property({ type: Label }) public scoreLabel: Label | null = null;\r\n    @property({ type: Label }) public timerLabel: Label | null = null;\r\n    @property({ type: Label }) public stateLabel: Label | null = null;\r\n    @property({ type: Node }) public puzzleContainer: Node | null = null;\r\n    // Вместо путей текстом, давай сделаем массив картинок прямо в Инспекторе\r\n    @property([SpriteFrame]) public levelImages: SpriteFrame[] = [];\r\n\r\n    // Появится в инспекторе как выпадающий список!\r\n    @property({ type: VictoryEffect }) public victoryEffect: VictoryEffect = VictoryEffect.BOUNCE_WAVE;\r\n\r\n    @property public useConfetti: boolean = true;\r\n\r\n    @property(UIManager) public ui: UIManager = null!;\r\n\r\n    @property({ tooltip: \"Если включено, уровни меняются сами\" })\r\n    public autoNextLevel: boolean = true;\r\n\r\n\r\n\r\n    private levels: ILevel[] = [\r\n        { rows: 3, cols: 3, time: 60, maxClicks: 10, penaltyTime: 2, hasFreeze: false, hasSpinOut: false },\r\n        { rows: 4, cols: 4, time: 80, maxClicks: 6, penaltyTime: 5, hasFreeze: true, hasSpinOut: false },\r\n        { rows: 6, cols: 6, time: 1000, maxClicks: 5, penaltyTime: 10, hasFreeze: true, hasSpinOut: true }\r\n    ];\r\n\r\n    private currentLevelIdx: number = 0;\r\n    private currentTime: number = 0;\r\n    private isGameOver: boolean = false;\r\n    private score: number = 0; // Привет! Gemini!\r\n\r\n    onLoad() {\r\n        // this.startLevel(this.currentLevelIdx);\r\n    }\r\n\r\n    start() {\r\n        if (this.ui) {\r\n            this.ui.switchWindow(null, 'GamePlay'); // 'GamePlay' закрывает все окна и запускает игру\r\n        }\r\n        this.startLevel(this.currentLevelIdx);\r\n    }\r\n\r\n    // Когда пазл собран, вызывай это:\r\n    public onWin() {\r\n        if (this.ui) this.ui.switchWindow(null, 'Window_Victory');\r\n    }\r\n\r\n    // Метод специально для кнопки \"Next\" или авто-перехода\r\n    // Внутри класса Game в Game.ts\r\n    public startNextLevel() {\r\n        this.currentLevelIdx++;\r\n        if (this.currentLevelIdx < this.levels.length) {\r\n            this.startLevel(this.currentLevelIdx);\r\n        } else {\r\n            // Если уровни кончились — в меню\r\n            // this.ui.showState('MENU');\r\n            if (this.ui) this.ui.switchWindow(null, 'Window_Victory');\r\n            this.currentLevelIdx = 0;\r\n        }\r\n    }\r\n\r\n    // Метод для кнопок выбора уровня (1, 2, 3...)\r\n    public onLevelSelectClick(event: any, levelIndex: string) {\r\n        // 1. Закрываем UI, возвращаемся в игру\r\n        if (this.ui) {\r\n            this.ui.switchWindow(null, 'GamePlay');\r\n        }\r\n\r\n        // 2. Запускаем выбранный уровень\r\n        // levelIndex придет из CustomEventData как строка \"0\", \"1\" и т.д.\r\n        const idx = parseInt(levelIndex);\r\n\r\n        if (!isNaN(idx) && idx < this.levels.length) {\r\n            this.currentLevelIdx = idx;\r\n            this.startLevel(this.currentLevelIdx);\r\n            console.log(\"Загружаем уровень №:\", idx + 1);\r\n        } else {\r\n            console.error(\"Уровень с индексом \" + levelIndex + \" не найден!\");\r\n        }\r\n    }\r\n\r\n    // Метод для кнопки Рестарт\r\n    public onRestartClick() {\r\n        // 1. Закрываем UI (если кнопка нажата в окне паузы или победы)\r\n        if (this.ui) {\r\n            this.ui.switchWindow(null, 'GamePlay');\r\n        }\r\n\r\n        // 2. Перезапускаем текущий уровень\r\n        console.log(\"Рестарт уровня:\", this.currentLevelIdx + 1);\r\n        this.startLevel(this.currentLevelIdx);\r\n    }\r\n    \r\n    startLevel(idx: number) {\r\n        const config = this.levels[idx];\r\n        this.currentTime = config.time;\r\n        this.isGameOver = true; // <--- ВАЖНО: блокируем клики здесь\r\n\r\n        // Сразу обновляем текст, чтобы игрок видел цифры до старта\r\n        if (this.timerLabel) this.timerLabel.string = \"Time: \" + this.currentTime;\r\n        if (this.scoreLabel) this.scoreLabel.string = \"Score: 0\";\r\n\r\n        if (this.stateLabel) this.stateLabel.string = \"\";\r\n        this.puzzleContainer?.removeAllChildren();\r\n\r\n        const image = this.levelImages[idx];\r\n        if (image) {\r\n            this.setupGrid(image, config);\r\n            this.startCountdown();\r\n        }\r\n    }\r\n\r\n    private countdownValue: number = 3;\r\n\r\n    startCountdown() {\r\n        if (!this.stateLabel) return;\r\n\r\n        this.unschedule(this.doCountdownTick); // Чистим старые циклы\r\n        this.unschedule(this._timer);          // Чистим старый таймер\r\n\r\n        this.countdownValue = 3;\r\n        this.isGameOver = true;                // КЛИКИ ЗАБЛОКИРОВАНЫ\r\n        this.stateLabel.node.active = true;\r\n\r\n        // Запускаем строго: 4 тика (3, 2, 1, GO) с интервалом в 1 сек\r\n        this.schedule(this.doCountdownTick, 1, 3, 0);\r\n        this.doCountdownTick(); // Первый тик (цифра 3) сразу\r\n    }\r\n\r\n    doCountdownTick() {\r\n        if (!this.stateLabel) return;\r\n\r\n        if (this.countdownValue > 0) {\r\n            this.stateLabel.string = this.countdownValue.toString();\r\n\r\n            // Твоя анимация пульсации\r\n            this.stateLabel.node.setScale(new Vec3(0.5, 0.5, 1));\r\n            tween(this.stateLabel.node)\r\n                .to(0.2, { scale: new Vec3(1.2, 1.2, 1) }, { easing: 'backOut' })\r\n                .start();\r\n\r\n            this.countdownValue--;\r\n        } else {\r\n            // ЭТОТ БЛОК СРАБОТАЕТ ТОЛЬКО ОДИН РАЗ ДЛЯ \"GO!\"\r\n            this.stateLabel.string = \"GO!\";\r\n            this.isGameOver = false; // ТЕПЕРЬ МОЖНО КЛИКАТЬ\r\n\r\n            this.unschedule(this._timer);\r\n            this.schedule(this._timer, 1); // ВКЛЮЧАЕМ ТАЙМЕР\r\n\r\n            // Прячем надпись \"GO!\" через полсекунды\r\n            this.scheduleOnce(() => {\r\n                if (this.stateLabel && this.stateLabel.string === \"GO!\") {\r\n                    this.stateLabel.string = \"\";\r\n                }\r\n            }, 0.5);\r\n\r\n            // Важно: останавливаем сам отсчет, чтобы он не зашел на второй круг\r\n            this.unschedule(this.doCountdownTick);\r\n        }\r\n    }\r\n\r\n    setupGrid(sprf: SpriteFrame, config: ILevel) {\r\n        this.isGameOver = true; // Запираем игру на замок, пока идет подготовка\r\n        const imgSize = sprf.originalSize;\r\n        const rectW = imgSize.width / config.cols;\r\n        const rectH = imgSize.height / config.rows;\r\n\r\n        for (let i = 0; i < config.rows; i++) {\r\n            for (let j = 0; j < config.cols; j++) {\r\n                const piece = new Node(`Piece_${i}_${j}`);\r\n                piece.layer = Layers.Enum.UI_2D;\r\n\r\n                const ui = piece.addComponent(UITransform);\r\n                ui.setContentSize(rectW, rectH);\r\n\r\n                const sprite = piece.addComponent(Sprite);\r\n                const frame = sprf.clone();\r\n                frame.rect = rect(j * rectW, i * rectH, rectW, rectH);\r\n                sprite.spriteFrame = frame;\r\n\r\n                // ВАЖНО: Добавляем строго в контейнер!\r\n                if (this.puzzleContainer) {\r\n                    this.puzzleContainer.addChild(piece);\r\n                }\r\n\r\n                const posX = j * rectW - imgSize.width / 2 + rectW / 2;\r\n                const posY = i * rectH - imgSize.height / 2 + rectH / 2;\r\n                piece.setPosition(posX, -posY, 0);\r\n\r\n                const angles = [0, 90, 180, 270];\r\n                piece.angle = angles[math.randomRangeInt(0, 4)];\r\n\r\n                piece['clickCount'] = 0;\r\n                piece['isLocked'] = false;\r\n\r\n                piece.on(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver) return;\r\n\r\n        const target = event.target as Node;\r\n        const config = this.levels[this.currentLevelIdx];\r\n\r\n        // 1. БЛОКИРОВКА: Если деталь заморожена или заблокирована — выходим\r\n        if (target['isLocked'] || target['isFrozen']) {\r\n            console.log(\"Действие заблокировано: деталь заморожена\");\r\n            return;\r\n        }\r\n\r\n        target['clickCount']++;\r\n\r\n        // 2. ПРОВЕРКА ШТРАФА\r\n        if (target['clickCount'] > config.maxClicks) {\r\n            this.applyPenalty(target, config);\r\n            // Мы НЕ вызываем rotatePiece здесь, деталь просто замирает и синеет\r\n            return;\r\n        }\r\n\r\n        // 3. ВРАЩЕНИЕ (срабатывает, только если всё ок)\r\n        this.rotatePiece(target);\r\n    }\r\n\r\n    rotatePiece(target: Node) {\r\n        if (target['isRotating']) return;\r\n        target['isRotating'] = true;\r\n\r\n        const config = this.levels[this.currentLevelIdx];\r\n        let rotationCount = 1;\r\n\r\n        // Если на уровне включен Spin-Out, есть шанс 20%, что деталь крутанется сильнее\r\n        if (config.hasSpinOut && Math.random() < 0.2) {\r\n            rotationCount = Math.floor(Math.random() * 3) + 1;\r\n        }\r\n\r\n        let targetAngle = target.angle - (90 * rotationCount);\r\n\r\n        tween(target)\r\n            .to(0.2 * rotationCount, { angle: targetAngle }, { easing: 'sineOut' })\r\n            .call(() => {\r\n                target.angle = Math.round(target.angle) % 360;\r\n                target['isRotating'] = false;\r\n                this._score();\r\n            })\r\n            .start();\r\n    }\r\n\r\n    applyPenalty(target: Node, config: ILevel) {\r\n        if (this.isGameOver) return;\r\n\r\n        // 1. СТОП: Гасим старый таймер, чтобы он не тикнул в момент штрафа\r\n        this.unschedule(this._timer);\r\n\r\n        // 2. РАСЧЕТ: Отнимаем штраф\r\n        this.currentTime -= config.penaltyTime;\r\n\r\n        // 3. ПРОВЕРКА: Если ушли в минус или ноль\r\n        if (this.currentTime <= 0) {\r\n            this.game_over(\"OUT OF TIME!\");\r\n        }\r\n        else {\r\n            // Если еще живы, обновляем текст и запускаем таймер заново\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: \" + this.currentTime;\r\n            this.triggerPenaltyVisual(config.penaltyTime);\r\n            this.schedule(this._timer, 1);\r\n        }\r\n\r\n        target['clickCount'] = 0;\r\n        this.freezePiece(target);\r\n    }\r\n\r\n    freezePiece(target: Node) {\r\n        target['isFrozen'] = true;\r\n        const sprite = target.getComponent(Sprite);\r\n\r\n        if (sprite) {\r\n            // Включаем встроенный черно-белый режим\r\n            sprite.grayscale = true;\r\n        }\r\n\r\n        this.scheduleOnce(() => {\r\n            target['isFrozen'] = false;\r\n            if (sprite) {\r\n                // Выключаем и возвращаем цвета\r\n                sprite.grayscale = false;\r\n            }\r\n        }, 2);\r\n    }\r\n\r\n    _timer() {\r\n        if (this.isGameOver) return;\r\n\r\n        this.currentTime--;\r\n\r\n        // Проверка СРАЗУ после вычитания\r\n        if (this.currentTime <= 0) {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n            this.game_over(\"TIME IS UP!\"); // Метод, где ставится isGameOver = true\r\n            return;\r\n        }\r\n\r\n        if (this.timerLabel) {\r\n            this.timerLabel.string = \"Time: \" + this.currentTime;\r\n        }\r\n    }\r\n\r\n    _score() {\r\n        let correctPieces = 0;\r\n        if (this.puzzleContainer) {\r\n            // Считаем текущее количество правильно повернутых деталей\r\n            this.puzzleContainer.children.forEach(child => {\r\n                let angle = Math.round(child.angle) % 360;\r\n                if (Math.abs(angle) === 0 || Math.abs(angle) === 360) {\r\n                    correctPieces++;\r\n                }\r\n            });\r\n        }\r\n\r\n        this.score = correctPieces;\r\n\r\n        if (this.scoreLabel) {\r\n            this.scoreLabel.string = \"Score: \" + this.score;\r\n        }\r\n\r\n        // ОПРЕДЕЛЯЕМ ОБЩЕЕ КОЛИЧЕСТВО ДЕТАЛЕЙ\r\n        const config = this.levels[this.currentLevelIdx];\r\n        const totalPieces = config.rows * config.cols; // Вот решение ошибки!\r\n\r\n        // ПРОВЕРКА ПОБЕДЫ\r\n        if (this.score === totalPieces && !this.isGameOver) {\r\n            this.isGameOver = true;\r\n            this.unschedule(this._timer);\r\n\r\n            this.victoryAnimation();\r\n\r\n            // Задержка перед финальным экраном, чтобы успела проиграться анимация\r\n            this.scheduleOnce(() => {\r\n                this.game_over(\"VICTORY!\");\r\n            }, 1.2);\r\n        }\r\n    }\r\n\r\n    victoryAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        // Запускаем конфетти, если галочка стоит\r\n        if (this.useConfetti) {\r\n            this.spawnConfetti();\r\n        }\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            const delay = index * 0.05;\r\n\r\n            if (this.victoryEffect === VictoryEffect.SPIN_WAVE) {\r\n                // Анимация с вращением\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.2, { scale: new Vec3(1.1, 1.1, 1) })\r\n                        .by(0.4, { angle: 360 }, { easing: 'quartOut' })\r\n                        .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                        .start();\r\n                }, delay);\r\n\r\n            } else if (this.victoryEffect === VictoryEffect.BOUNCE_WAVE) {\r\n                // Анимация с прыжком (без вращения)\r\n                const originalPos = piece.position.clone();\r\n                const upPos = new Vec3(originalPos.x, originalPos.y + 40, originalPos.z);\r\n\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.15, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                        .to(0.15, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                        .start();\r\n                }, delay);\r\n            }\r\n        });\r\n    }\r\n    spawnConfetti() {\r\n        const colors = [Color.RED, Color.GREEN, Color.BLUE, Color.YELLOW, Color.CYAN, Color.MAGENTA];\r\n\r\n        // Берем текстуру от первого попавшегося кусочка пазла, чтобы не искать в ресурсах\r\n        const referenceSprite = this.puzzleContainer?.getComponentInChildren(Sprite)?.spriteFrame;\r\n\r\n        for (let i = 0; i < 40; i++) {\r\n            const particle = new Node(\"Confetti\");\r\n            particle.layer = Layers.Enum.UI_2D;\r\n\r\n            const ui = particle.addComponent(UITransform);\r\n            ui.setContentSize(20, 20);\r\n\r\n            const sprite = particle.addComponent(Sprite);\r\n            if (referenceSprite) {\r\n                sprite.spriteFrame = referenceSprite; // Даем картинку\r\n            }\r\n            sprite.color = colors[math.randomRangeInt(0, colors.length)];\r\n\r\n            // Добавляем в Canvas или прямо в Game Node, чтобы было ВЫШЕ пазлов\r\n            this.node.parent.addChild(particle);\r\n\r\n            // Устанавливаем Z-index повыше (для UI в Cocos 3.x это порядок в иерархии)\r\n            particle.setSiblingIndex(100);\r\n\r\n            particle.setPosition(0, 0, 0);\r\n\r\n            const destX = math.randomRange(-600, 600);\r\n            const destY = math.randomRange(-600, 600);\r\n            const duration = math.randomRange(0.8, 1.5);\r\n\r\n            tween(particle)\r\n                .to(duration, {\r\n                    position: new Vec3(destX, destY, 0),\r\n                    angle: math.randomRange(0, 360),\r\n                    scale: new Vec3(0.2, 0.2, 0.2)\r\n                }, { easing: 'circOut' })\r\n                .call(() => particle.destroy())\r\n                .start();\r\n        }\r\n    }\r\n\r\n    bounceWaveAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            // Сохраняем начальную позицию, чтобы деталь вернулась точно на место\r\n            const originalPos = piece.position.clone();\r\n            const upPos = new Vec3(originalPos.x, originalPos.y + 30, originalPos.z);\r\n\r\n            this.scheduleOnce(() => {\r\n                tween(piece)\r\n                    // 1. Прыжок вверх и легкое увеличение\r\n                    .to(0.2, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                    // 2. Возвращение вниз с \"приземлением\"\r\n                    .to(0.2, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                    .start();\r\n            }, index * 0.05); // Та самая задержка для эффекта волны\r\n        });\r\n    }\r\n\r\n    game_over(reason: string = \"Game Over\") {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n\r\n        if (this.stateLabel) {\r\n            // УСТАНАВЛИВАЕМ БЕЛЫЙ ЦВЕТ (чтобы после красного штрафа Victory была белой)\r\n            this.stateLabel.color = Color.WHITE;\r\n\r\n            this.stateLabel.string = reason;\r\n            this.stateLabel.node.active = true;\r\n\r\n            // Твоя крутая анимация\r\n            this.stateLabel.node.setScale(new Vec3(0, 0, 0));\r\n            this.stateLabel.node.angle = -45;\r\n\r\n            tween(this.stateLabel.node)\r\n                .to(0.5, { scale: new Vec3(1.2, 1.2, 1), angle: 0 }, { easing: 'backOut' })\r\n                .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                .start();\r\n        }\r\n\r\n        // Если это проигрыш, обнуляем таймер. Если победа — оставляем как есть.\r\n        if (reason !== \"VICTORY!\") {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n        }\r\n\r\n        this.stopGame();\r\n\r\n        if (reason === \"VICTORY!\") {\r\n            //this.ui.showState('VICTORY');\r\n            if (this.ui) this.ui.switchWindow(null, 'Window_Victory');\r\n            // Больше ничего не делаем. Ждем, пока игрок нажмет кнопку, \r\n            // которая вызовет UIManager -> onNextLevelBtnClick\r\n        }\r\n    }\r\n\r\n    stopGame() {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n        this.node.children.forEach(child => {\r\n            child.off(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        });\r\n    }\r\n\r\n    triggerPenaltyVisual(penalty: number) {\r\n        if (!this.stateLabel) return;\r\n\r\n        // Показываем, сколько именно отняли\r\n        this.stateLabel.string = `-${penalty} SEC!`;\r\n        this.stateLabel.node.active = true;\r\n        const originalColor = this.stateLabel.color.clone();\r\n        this.stateLabel.color = Color.RED;\r\n\r\n        // Тряска или просто исчезновение\r\n        tween(this.stateLabel.node)\r\n            .to(0.1, { scale: new Vec3(1.2, 1.2, 1) })\r\n            .to(0.1, { scale: new Vec3(1, 1, 1) })\r\n            .delay(0.5)\r\n            .call(() => {\r\n                if (this.stateLabel) {\r\n                    this.stateLabel.string = \"\";\r\n                    this.stateLabel.color = originalColor;\r\n                }\r\n            })\r\n            .start();\r\n    }\r\n\r\n    onDestroy() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}"]}