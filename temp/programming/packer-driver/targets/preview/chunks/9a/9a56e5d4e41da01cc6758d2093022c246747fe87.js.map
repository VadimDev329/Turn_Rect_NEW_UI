{"version":3,"sources":["file:///D:/ENGINES/Cocos/PROJECTS/103_2/387/ST/NEW/Rect/Turn_Rect_NEW_UI/assets/resources/scripts/Game_Turn7.ts"],"names":["_decorator","Component","Node","rect","Label","resources","Sprite","SpriteFrame","math","UITransform","Layers","tween","ccclass","property","Game","type","row","col","count","score","isGameOver","onLoad","load","err","image","console","error","cut_out4","schedule","_timer","sprf","imgSize","originalSize","rectW","width","rectH","height","i","j","piece","layer","Enum","UI_2D","ui","addComponent","setContentSize","sprite","angle","grayscale","frame","clone","spriteFrame","node","addChild","posX","posY","setPosition","angles","randomRangeInt","on","EventType","TOUCH_START","onTouchStart","event","target","triggerPenaltyVisual","timerLabel","string","log","targetAngle","to","easing","call","currentAngle","Math","round","abs","game_victory","start","game_over","_score","go","children","forEach","child","scoreX","game_state","stopGame","unschedule","off","onDestroy","unscheduleAllCallbacks","label","getComponent","startPos","position","originalColor","color","scale","Vec3","x","y","delay"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Rect, rect, Label, resources, Sprite, SpriteFrame, math, EventTouch, UITransform, Layers, tween, Vec3 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Game')\r\nexport class Game extends Component {\r\n\r\n    @property({ type: Label }) public scoreX: Label | null = null;\r\n    @property({ type: Label }) public timerLabel: Label | null = null;\r\n    @property({ type: Label }) public game_state: Label | null = null;\r\n\r\n    private row: number = 6;\r\n    private col: number = 6;\r\n    private count: number = 80;\r\n    private score: number = 0;\r\n    private isGameOver: boolean = false;\r\n\r\n    onLoad() {\r\n        // Загрузка ресурсов\r\n        resources.load('images/110/spriteFrame', SpriteFrame, (err, image) => {\r\n            if (err) return console.error(err);\r\n            this.cut_out4(image);\r\n            this.schedule(this._timer, 1);\r\n        });\r\n    }\r\n\r\n    cut_out4(sprf: SpriteFrame) {\r\n        const imgSize = sprf.originalSize;\r\n        const rectW = imgSize.width / this.col;\r\n        const rectH = imgSize.height / this.row;\r\n\r\n        for (let i = 0; i < this.row; i++) {\r\n            for (let j = 0; j < this.col; j++) {\r\n                const piece = new Node(`Piece_${i}_${j}`);\r\n                piece.layer = Layers.Enum.UI_2D;\r\n\r\n                // 1. Добавляем UITransform (КРИТИЧНО для кликов в 3.x)\r\n                const ui = piece.addComponent(UITransform);\r\n                ui.setContentSize(rectW, rectH);\r\n\r\n                // 2. Спрайт\r\n                const sprite = piece.addComponent(Sprite);\r\n                if (piece.angle !== 0) {\r\n                    sprite.grayscale = true;\r\n                }\r\n                const frame = sprf.clone();\r\n                frame.rect = rect(j * rectW, i * rectH, rectW, rectH);\r\n                sprite.spriteFrame = frame;\r\n\r\n                this.node.addChild(piece);\r\n\r\n                // 3. Позиция\r\n                const posX = j * rectW - imgSize.width / 2 + rectW / 2;\r\n                const posY = i * rectH - imgSize.height / 2 + rectH / 2;\r\n                piece.setPosition(posX, -posY, 0);\r\n\r\n                // 4. Рандомный поворот\r\n                const angles = [0, 90, 180, 270];\r\n                piece.angle = angles[math.randomRangeInt(0, 4)];\r\n\r\n                // 5. ПОДПИСЫВАЕМ КАЖДЫЙ КУСОЧИК (как в твоем рабочем коде)\r\n                piece.on(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver) return;\r\n        const target = event.target as Node;\r\n\r\n        // --- ЛОГИКА ШТРАФА (Усложнение) ---\r\n        if (!target['clickCount']) target['clickCount'] = 0;\r\n        target['clickCount']++;\r\n\r\n        // Если игрок \"заспамил\" деталь (например, более 6 кликов)\r\n        if (target['clickCount'] > 6) {\r\n            this.count -= 5; // Штраф: -5 секунд\r\n            target['clickCount'] = 0; // Сброс счетчика\r\n            this.triggerPenaltyVisual(); // Вызываем нашу вспышку!\r\n\r\n            if (this.timerLabel) this.timerLabel.string = \"TIME \" + this.count;\r\n            console.log(\"Штраф за лишние клики! -5 сек\");\r\n            // Можно добавить визуальную встряску (shake), если захочешь\r\n        }\r\n\r\n        // --- ОСНОВНАЯ МЕХАНИКА (Поворот) ---\r\n        let targetAngle = target.angle + 90;\r\n\r\n        tween(target)\r\n            .to(0.2, { angle: targetAngle }, { easing: 'sineOut' })\r\n            .call(() => {\r\n                // Нормализация угла\r\n                let currentAngle = Math.round(target.angle) % 360;\r\n                if (Math.abs(currentAngle) === 0) target.angle = 0;\r\n\r\n                // --- ПОДСКАЗКА (ЗАКОММЕНТИРОВАНО) ---\r\n                /* const sprite = target.getComponent(Sprite);\r\n                if (sprite) {\r\n                    sprite.grayscale = (target.angle !== 0);\r\n                }\r\n                */\r\n\r\n                this.game_victory();\r\n            })\r\n            .start();\r\n    }\r\n\r\n    // --- Остальная логика без изменений ---\r\n\r\n    _timer() {\r\n        if (this.isGameOver) return;\r\n\r\n        this.count--;\r\n\r\n        // Проверяем через консоль, идет ли счет\r\n        console.log(\"Осталось времени:\", this.count);\r\n\r\n        if (this.timerLabel) {\r\n            this.timerLabel.string = \"TIME \" + this.count;\r\n        }\r\n\r\n        if (this.count <= 0) {\r\n            this.game_over();\r\n        }\r\n    }\r\n\r\n    _score() {\r\n        let go = 0;\r\n        this.node.children.forEach(child => {\r\n            // Используем Math.round, чтобы исключить микро-ошибки плавающей точки\r\n            let currentAngle = Math.round(child.angle) % 360;\r\n\r\n            // В JS % может вернуть -90, поэтому берем абсолютное значение\r\n            if (Math.abs(currentAngle) === 0) {\r\n                go++;\r\n            }\r\n        });\r\n\r\n        this.score = go;\r\n        console.log(\"Текущий счет:\", this.score, \"из\", this.col * this.row);\r\n\r\n        if (this.scoreX) {\r\n            this.scoreX.string = \"Score \" + this.score;\r\n        }\r\n    }\r\n\r\n    game_victory() {\r\n        this._score();\r\n        if (this.score === this.col * this.row) {\r\n            if (this.game_state) this.game_state.string = \"Victory!\";\r\n            this.stopGame();\r\n        }\r\n    }\r\n\r\n    game_over() {\r\n        if (this.game_state) this.game_state.string = \"Game Over\";\r\n        this.stopGame();\r\n    }\r\n\r\n    stopGame() {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n        // Снимаем слушателей с каждого ребенка\r\n        this.node.children.forEach(child => {\r\n            child.off(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        });\r\n    }\r\n\r\n    onDestroy() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n\r\n    private triggerPenaltyVisual() {\r\n        if (!this.timerLabel) return;\r\n\r\n        const node = this.timerLabel.node;\r\n        const label = node.getComponent(Label)!;\r\n\r\n        // 1. Сохраняем исходные данные, чтобы вернуться к ним\r\n        const startPos = node.position.clone();\r\n        const originalColor = label.color.clone();\r\n\r\n        // 2. Тряска относительно СТАРТОВОЙ позиции\r\n        tween(node)\r\n            .to(0.05, { scale: new math.Vec3(1.2, 1.2, 1) })\r\n            .call(() => { label.color = math.color(255, 0, 0); })\r\n            // Используем прибавление к текущей позиции, а не замену на (5, 0, 0)\r\n            .to(0.05, { position: new math.Vec3(startPos.x + 10, startPos.y, 0) })\r\n            .to(0.05, { position: new math.Vec3(startPos.x - 10, startPos.y, 0) })\r\n            .to(0.05, { position: new math.Vec3(startPos.x, startPos.y, 0) })\r\n            .delay(0.2)\r\n            .to(0.1, { scale: new math.Vec3(1, 1, 1) })\r\n            .call(() => { label.color = originalColor; })\r\n            .start();\r\n    }\r\n}"]}