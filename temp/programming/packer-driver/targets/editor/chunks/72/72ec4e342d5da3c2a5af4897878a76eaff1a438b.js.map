{"version":3,"sources":["file:///D:/ENGINES/Cocos/PROJECTS/103_2/387/ST/NEW/Rect/Turn_Rect_NEW_UI/assets/resources/scripts/Game_Turn10.ts"],"names":["_decorator","Component","Node","Label","Sprite","SpriteFrame","math","UITransform","Layers","rect","tween","Vec3","Color","Enum","ccclass","property","VictoryEffect","Game","type","levels","rows","cols","time","maxClicks","penaltyTime","hasFreeze","hasSpinOut","currentLevelIdx","currentTime","isGameOver","score","countdownValue","onLoad","startLevel","idx","config","stateLabel","string","puzzleContainer","removeAllChildren","image","levelImages","setupGrid","startCountdown","node","active","unschedule","doCountdownTick","schedule","toString","setScale","to","scale","easing","start","_timer","scheduleOnce","sprf","imgSize","originalSize","rectW","width","rectH","height","i","j","piece","layer","UI_2D","ui","addComponent","setContentSize","sprite","frame","clone","spriteFrame","addChild","posX","posY","setPosition","angles","angle","randomRangeInt","on","EventType","TOUCH_START","onTouchStart","event","target","console","log","applyPenalty","rotatePiece","rotationCount","Math","random","floor","targetAngle","call","round","_score","game_over","timerLabel","triggerPenaltyVisual","freezePiece","getComponent","grayscale","correctPieces","children","forEach","child","abs","scoreLabel","totalPieces","victoryAnimation","useConfetti","spawnConfetti","pieces","index","delay","victoryEffect","SPIN_WAVE","by","BOUNCE_WAVE","originalPos","position","upPos","x","y","z","colors","RED","GREEN","BLUE","YELLOW","CYAN","MAGENTA","referenceSprite","getComponentInChildren","particle","color","length","setSiblingIndex","destX","randomRange","destY","duration","destroy","bounceWaveAnimation","reason","WHITE","stopGame","off","penalty","originalColor","onDestroy","unscheduleAllCallbacks"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Label, resources, Sprite, SpriteFrame, math, EventTouch, UITransform, Layers, rect, tween, Vec3, Color, Enum } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\ninterface ILevel {\r\n    rows: number;\r\n    cols: number;\r\n    time: number;\r\n    maxClicks: number;\r\n    penaltyTime: number;\r\n    hasFreeze: boolean;\r\n    hasSpinOut: boolean;\r\n}\r\n\r\n// Создаем список доступных анимаций\r\nenum VictoryEffect {\r\n    SPIN_WAVE,   // Вращательная волна\r\n    BOUNCE_WAVE, // Прыгающая волна\r\n    NONE         // Без анимации\r\n}\r\n// Регистрируем Enum для инспектора\r\nEnum(VictoryEffect);\r\n\r\n@ccclass('Game')\r\nexport class Game extends Component {\r\n    // Убедись, что в Инспекторе привязаны эти три Label!\r\n    @property({ type: Label }) public scoreLabel: Label | null = null;\r\n    @property({ type: Label }) public timerLabel: Label | null = null;\r\n    @property({ type: Label }) public stateLabel: Label | null = null;\r\n    @property({ type: Node }) public puzzleContainer: Node | null = null;\r\n    // Вместо путей текстом, давай сделаем массив картинок прямо в Инспекторе\r\n    @property([SpriteFrame]) public levelImages: SpriteFrame[] = [];\r\n\r\n    // Появится в инспекторе как выпадающий список!\r\n    @property({ type: VictoryEffect }) public victoryEffect: VictoryEffect = VictoryEffect.BOUNCE_WAVE;\r\n\r\n    @property public useConfetti: boolean = true;\r\n\r\n    private levels: ILevel[] = [\r\n        { rows: 3, cols: 3, time: 60, maxClicks: 10, penaltyTime: 2, hasFreeze: false, hasSpinOut: false },\r\n        { rows: 4, cols: 4, time: 80, maxClicks: 6, penaltyTime: 5, hasFreeze: true, hasSpinOut: false },\r\n        { rows: 6, cols: 6, time: 100, maxClicks: 5, penaltyTime: 10, hasFreeze: true, hasSpinOut: true }\r\n    ];\r\n\r\n    private currentLevelIdx: number = 0;\r\n    private currentTime: number = 0;\r\n    private isGameOver: boolean = false;\r\n    private score: number = 0;\r\n\r\n    onLoad() {\r\n        this.startLevel(this.currentLevelIdx);\r\n    }\r\n\r\n    startLevel(idx: number) {\r\n        const config = this.levels[idx];\r\n        this.currentTime = config.time;\r\n        this.isGameOver = true; // Блокируем клики, пока идет отсчет!\r\n\r\n        if (this.stateLabel) this.stateLabel.string = \"\";\r\n        this.puzzleContainer?.removeAllChildren();\r\n\r\n        const image = this.levelImages[idx];\r\n        if (image) {\r\n            this.setupGrid(image, config);\r\n            this.startCountdown(); // Запускаем отсчет вместо таймера\r\n        }\r\n    }\r\n\r\n    private countdownValue: number = 3;\r\n\r\n    startCountdown() {\r\n        if (!this.stateLabel) return;\r\n\r\n        this.countdownValue = 3; // Сбрасываем значение\r\n        this.isGameOver = true;   // Блокируем клики\r\n        this.stateLabel.node.active = true;\r\n\r\n        // Сначала останавливаем все старые планировщики для этого метода\r\n        this.unschedule(this.doCountdownTick);\r\n        // Запускаем новый цикл каждую 1 секунду\r\n        this.schedule(this.doCountdownTick, 1, 3); // 1 сек, повторить 3 раза\r\n\r\n        // Вызываем первый раз вручную, чтобы не ждать секунду до появления \"3\"\r\n        this.doCountdownTick();\r\n    }\r\n\r\n    doCountdownTick() {\r\n        if (!this.stateLabel) return;\r\n\r\n        if (this.countdownValue > 0) {\r\n            this.stateLabel.string = this.countdownValue.toString();\r\n\r\n            // Эффект пульсации\r\n            this.stateLabel.node.setScale(new Vec3(0.5, 0.5, 1));\r\n            tween(this.stateLabel.node)\r\n                .to(0.2, { scale: new Vec3(1.2, 1.2, 1) }, { easing: 'backOut' })\r\n                .start();\r\n\r\n            this.countdownValue--;\r\n        } else {\r\n            this.stateLabel.string = \"GO!\";\r\n            this.isGameOver = false; // Погнали!\r\n\r\n            this.unschedule(this._timer); // На всякий случай\r\n            this.schedule(this._timer, 1); // Включаем основной таймер\r\n\r\n            this.scheduleOnce(() => {\r\n                if (this.stateLabel && this.stateLabel.string === \"GO!\") {\r\n                    this.stateLabel.string = \"\";\r\n                }\r\n            }, 0.5);\r\n        }\r\n    }\r\n\r\n  setupGrid(sprf: SpriteFrame, config: ILevel) {\r\n        const imgSize = sprf.originalSize;\r\n        const rectW = imgSize.width / config.cols;\r\n        const rectH = imgSize.height / config.rows;\r\n\r\n        for (let i = 0; i < config.rows; i++) {\r\n            for (let j = 0; j < config.cols; j++) {\r\n                const piece = new Node(`Piece_${i}_${j}`);\r\n                piece.layer = Layers.Enum.UI_2D;\r\n\r\n                const ui = piece.addComponent(UITransform);\r\n                ui.setContentSize(rectW, rectH);\r\n\r\n                const sprite = piece.addComponent(Sprite);\r\n                const frame = sprf.clone();\r\n                frame.rect = rect(j * rectW, i * rectH, rectW, rectH);\r\n                sprite.spriteFrame = frame;\r\n\r\n                // ВАЖНО: Добавляем строго в контейнер!\r\n                if (this.puzzleContainer) {\r\n                    this.puzzleContainer.addChild(piece);\r\n                }\r\n\r\n                const posX = j * rectW - imgSize.width / 2 + rectW / 2;\r\n                const posY = i * rectH - imgSize.height / 2 + rectH / 2;\r\n                piece.setPosition(posX, -posY, 0);\r\n\r\n                const angles = [0, 90, 180, 270];\r\n                piece.angle = angles[math.randomRangeInt(0, 4)];\r\n\r\n                piece['clickCount'] = 0;\r\n                piece['isLocked'] = false;\r\n\r\n                piece.on(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver) return;\r\n\r\n        const target = event.target as Node;\r\n        const config = this.levels[this.currentLevelIdx];\r\n\r\n        // 1. БЛОКИРОВКА: Если деталь заморожена или заблокирована — выходим\r\n        if (target['isLocked'] || target['isFrozen']) {\r\n            console.log(\"Действие заблокировано: деталь заморожена\");\r\n            return;\r\n        }\r\n\r\n        target['clickCount']++;\r\n\r\n        // 2. ПРОВЕРКА ШТРАФА\r\n        if (target['clickCount'] > config.maxClicks) {\r\n            this.applyPenalty(target, config);\r\n            // Мы НЕ вызываем rotatePiece здесь, деталь просто замирает и синеет\r\n            return;\r\n        }\r\n\r\n        // 3. ВРАЩЕНИЕ (срабатывает, только если всё ок)\r\n        this.rotatePiece(target);\r\n    }\r\n    \r\n    rotatePiece(target: Node) {\r\n        if (target['isRotating']) return;\r\n        target['isRotating'] = true;\r\n\r\n        const config = this.levels[this.currentLevelIdx];\r\n        let rotationCount = 1;\r\n\r\n        // Если на уровне включен Spin-Out, есть шанс 20%, что деталь крутанется сильнее\r\n        if (config.hasSpinOut && Math.random() < 0.2) {\r\n            rotationCount = Math.floor(Math.random() * 3) + 1;\r\n        }\r\n\r\n        let targetAngle = target.angle - (90 * rotationCount);\r\n\r\n        tween(target)\r\n            .to(0.2 * rotationCount, { angle: targetAngle }, { easing: 'sineOut' })\r\n            .call(() => {\r\n                target.angle = Math.round(target.angle) % 360;\r\n                target['isRotating'] = false;\r\n                this._score();\r\n            })\r\n            .start();\r\n    }\r\n\r\n    applyPenalty(target: Node, config: ILevel) {\r\n        if (this.isGameOver) return;\r\n\r\n        // 1. СТОП: Гасим старый таймер, чтобы он не тикнул в момент штрафа\r\n        this.unschedule(this._timer);\r\n\r\n        // 2. РАСЧЕТ: Отнимаем штраф\r\n        this.currentTime -= config.penaltyTime;\r\n\r\n        // 3. ПРОВЕРКА: Если ушли в минус или ноль\r\n        if (this.currentTime <= 0) {\r\n            this.game_over(\"OUT OF TIME!\");\r\n        }\r\n        else {\r\n            // Если еще живы, обновляем текст и запускаем таймер заново\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: \" + this.currentTime;\r\n            this.triggerPenaltyVisual(config.penaltyTime);\r\n            this.schedule(this._timer, 1);\r\n        }\r\n\r\n        target['clickCount'] = 0;\r\n        this.freezePiece(target);\r\n    }\r\n\r\n    freezePiece(target: Node) {\r\n        target['isFrozen'] = true;\r\n        const sprite = target.getComponent(Sprite);\r\n\r\n        if (sprite) {\r\n            // Включаем встроенный черно-белый режим\r\n            sprite.grayscale = true;\r\n        }\r\n\r\n        this.scheduleOnce(() => {\r\n            target['isFrozen'] = false;\r\n            if (sprite) {\r\n                // Выключаем и возвращаем цвета\r\n                sprite.grayscale = false;\r\n            }\r\n        }, 2);\r\n    }\r\n\r\n    _timer() {\r\n        if (this.isGameOver) return;\r\n\r\n        this.currentTime--;\r\n\r\n        // Проверка СРАЗУ после вычитания\r\n        if (this.currentTime <= 0) {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n            this.game_over(\"TIME IS UP!\"); // Метод, где ставится isGameOver = true\r\n            return;\r\n        }\r\n\r\n        if (this.timerLabel) {\r\n            this.timerLabel.string = \"Time: \" + this.currentTime;\r\n        }\r\n    }\r\n\r\n    _score() {\r\n        let correctPieces = 0;\r\n        if (this.puzzleContainer) {\r\n            // Считаем текущее количество правильно повернутых деталей\r\n            this.puzzleContainer.children.forEach(child => {\r\n                let angle = Math.round(child.angle) % 360;\r\n                if (Math.abs(angle) === 0 || Math.abs(angle) === 360) {\r\n                    correctPieces++;\r\n                }\r\n            });\r\n        }\r\n\r\n        this.score = correctPieces;\r\n\r\n        if (this.scoreLabel) {\r\n            this.scoreLabel.string = \"Score: \" + this.score;\r\n        }\r\n\r\n        // ОПРЕДЕЛЯЕМ ОБЩЕЕ КОЛИЧЕСТВО ДЕТАЛЕЙ\r\n        const config = this.levels[this.currentLevelIdx];\r\n        const totalPieces = config.rows * config.cols; // Вот решение ошибки!\r\n\r\n        // ПРОВЕРКА ПОБЕДЫ\r\n        if (this.score === totalPieces && !this.isGameOver) {\r\n            this.isGameOver = true;\r\n            this.unschedule(this._timer);\r\n\r\n            this.victoryAnimation();\r\n\r\n            // Задержка перед финальным экраном, чтобы успела проиграться анимация\r\n            this.scheduleOnce(() => {\r\n                this.game_over(\"VICTORY!\");\r\n            }, 1.2);\r\n        }\r\n    }\r\n   \r\n    victoryAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        // Запускаем конфетти, если галочка стоит\r\n        if (this.useConfetti) {\r\n            this.spawnConfetti();\r\n        }\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            const delay = index * 0.05;\r\n\r\n            if (this.victoryEffect === VictoryEffect.SPIN_WAVE) {\r\n                // Анимация с вращением\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.2, { scale: new Vec3(1.1, 1.1, 1) })\r\n                        .by(0.4, { angle: 360 }, { easing: 'quartOut' })\r\n                        .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                        .start();\r\n                }, delay);\r\n\r\n            } else if (this.victoryEffect === VictoryEffect.BOUNCE_WAVE) {\r\n                // Анимация с прыжком (без вращения)\r\n                const originalPos = piece.position.clone();\r\n                const upPos = new Vec3(originalPos.x, originalPos.y + 40, originalPos.z);\r\n\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.15, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                        .to(0.15, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                        .start();\r\n                }, delay);\r\n            }\r\n        });\r\n    }\r\n    spawnConfetti() {\r\n        const colors = [Color.RED, Color.GREEN, Color.BLUE, Color.YELLOW, Color.CYAN, Color.MAGENTA];\r\n\r\n        // Берем текстуру от первого попавшегося кусочка пазла, чтобы не искать в ресурсах\r\n        const referenceSprite = this.puzzleContainer?.getComponentInChildren(Sprite)?.spriteFrame;\r\n\r\n        for (let i = 0; i < 40; i++) {\r\n            const particle = new Node(\"Confetti\");\r\n            particle.layer = Layers.Enum.UI_2D;\r\n\r\n            const ui = particle.addComponent(UITransform);\r\n            ui.setContentSize(20, 20);\r\n\r\n            const sprite = particle.addComponent(Sprite);\r\n            if (referenceSprite) {\r\n                sprite.spriteFrame = referenceSprite; // Даем картинку\r\n            }\r\n            sprite.color = colors[math.randomRangeInt(0, colors.length)];\r\n\r\n            // Добавляем в Canvas или прямо в Game Node, чтобы было ВЫШЕ пазлов\r\n            this.node.addChild(particle);\r\n\r\n            // Устанавливаем Z-index повыше (для UI в Cocos 3.x это порядок в иерархии)\r\n            particle.setSiblingIndex(100);\r\n\r\n            particle.setPosition(0, 0, 0);\r\n\r\n            const destX = math.randomRange(-600, 600);\r\n            const destY = math.randomRange(-600, 600);\r\n            const duration = math.randomRange(0.8, 1.5);\r\n\r\n            tween(particle)\r\n                .to(duration, {\r\n                    position: new Vec3(destX, destY, 0),\r\n                    angle: math.randomRange(0, 360),\r\n                    scale: new Vec3(0.2, 0.2, 0.2)\r\n                }, { easing: 'circOut' })\r\n                .call(() => particle.destroy())\r\n                .start();\r\n        }\r\n    }\r\n\r\n    bounceWaveAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            // Сохраняем начальную позицию, чтобы деталь вернулась точно на место\r\n            const originalPos = piece.position.clone();\r\n            const upPos = new Vec3(originalPos.x, originalPos.y + 30, originalPos.z);\r\n\r\n            this.scheduleOnce(() => {\r\n                tween(piece)\r\n                    // 1. Прыжок вверх и легкое увеличение\r\n                    .to(0.2, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                    // 2. Возвращение вниз с \"приземлением\"\r\n                    .to(0.2, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                    .start();\r\n            }, index * 0.05); // Та самая задержка для эффекта волны\r\n        });\r\n    }\r\n\r\n    game_over(reason: string = \"Game Over\") {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n\r\n        if (this.stateLabel) {\r\n            // УСТАНАВЛИВАЕМ БЕЛЫЙ ЦВЕТ (чтобы после красного штрафа Victory была белой)\r\n            this.stateLabel.color = Color.WHITE;\r\n\r\n            this.stateLabel.string = reason;\r\n            this.stateLabel.node.active = true;\r\n\r\n            // Твоя крутая анимация\r\n            this.stateLabel.node.setScale(new Vec3(0, 0, 0));\r\n            this.stateLabel.node.angle = -45;\r\n\r\n            tween(this.stateLabel.node)\r\n                .to(0.5, { scale: new Vec3(1.2, 1.2, 1), angle: 0 }, { easing: 'backOut' })\r\n                .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                .start();\r\n        }\r\n\r\n        // Если это проигрыш, обнуляем таймер. Если победа — оставляем как есть.\r\n        if (reason !== \"VICTORY!\") {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n        }\r\n\r\n        this.stopGame();\r\n\r\n        // ВОТ ЭТОТ БЛОК \"АВТОПИЛОТА\":\r\n        if (reason === \"VICTORY!\") {\r\n            this.scheduleOnce(() => {\r\n                this.currentLevelIdx++; // Готовим следующий уровень\r\n\r\n                // Проверяем, есть ли у нас еще уровни в списке\r\n                if (this.currentLevelIdx < this.levels.length) {\r\n                    this.startLevel(this.currentLevelIdx);\r\n                } else {\r\n                    // Если уровни закончились\r\n                    if (this.stateLabel) this.stateLabel.string = \"YOU ARE THE CHAMPION!\";\r\n                    this.currentLevelIdx = 0; // Сбрасываем на начало на всякий случай\r\n                }\r\n            }, 4.0);\r\n        }\r\n    }\r\n\r\n    stopGame() {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n        this.node.children.forEach(child => {\r\n            child.off(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        });\r\n    }\r\n\r\n    triggerPenaltyVisual(penalty: number) {\r\n        if (!this.stateLabel) return;\r\n\r\n        // Показываем, сколько именно отняли\r\n        this.stateLabel.string = `-${penalty} SEC!`;\r\n        this.stateLabel.node.active = true;\r\n        const originalColor = this.stateLabel.color.clone();\r\n        this.stateLabel.color = Color.RED;\r\n\r\n        // Тряска или просто исчезновение\r\n        tween(this.stateLabel.node)\r\n            .to(0.1, { scale: new Vec3(1.2, 1.2, 1) })\r\n            .to(0.1, { scale: new Vec3(1, 1, 1) })\r\n            .delay(0.5)\r\n            .call(() => {\r\n                if (this.stateLabel) {\r\n                    this.stateLabel.string = \"\";\r\n                    this.stateLabel.color = originalColor;\r\n                }\r\n            })\r\n            .start();\r\n    }\r\n\r\n    onDestroy() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}"]}