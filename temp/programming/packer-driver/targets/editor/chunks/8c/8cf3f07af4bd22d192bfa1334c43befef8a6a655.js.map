{"version":3,"sources":["file:///D:/ENGINES/Cocos/PROJECTS/103_2/387/ST/NEW/Rect/Turn_Rect_NEW_UI/assets/resources/scripts/Game.ts"],"names":["_decorator","Component","Node","Label","Sprite","SpriteFrame","math","UITransform","Layers","rect","tween","Vec3","Color","Enum","UIManager","ccclass","property","VictoryEffect","Game","type","tooltip","levels","rows","cols","time","maxClicks","penaltyTime","hasFreeze","hasSpinOut","currentLevelIdx","currentTime","isGameOver","score","countdownValue","onLoad","start","ui","showState","startLevel","onWin","startNextLevel","length","idx","config","timerLabel","string","scoreLabel","stateLabel","puzzleContainer","removeAllChildren","image","levelImages","setupGrid","startCountdown","unschedule","doCountdownTick","_timer","node","active","schedule","toString","setScale","to","scale","easing","scheduleOnce","sprf","imgSize","originalSize","rectW","width","rectH","height","i","j","piece","layer","UI_2D","addComponent","setContentSize","sprite","frame","clone","spriteFrame","addChild","posX","posY","setPosition","angles","angle","randomRangeInt","on","EventType","TOUCH_START","onTouchStart","event","target","console","log","applyPenalty","rotatePiece","rotationCount","Math","random","floor","targetAngle","call","round","_score","game_over","triggerPenaltyVisual","freezePiece","getComponent","grayscale","correctPieces","children","forEach","child","abs","totalPieces","victoryAnimation","useConfetti","spawnConfetti","pieces","index","delay","victoryEffect","SPIN_WAVE","by","BOUNCE_WAVE","originalPos","position","upPos","x","y","z","colors","RED","GREEN","BLUE","YELLOW","CYAN","MAGENTA","referenceSprite","getComponentInChildren","particle","color","parent","setSiblingIndex","destX","randomRange","destY","duration","destroy","bounceWaveAnimation","reason","WHITE","stopGame","off","penalty","originalColor","onDestroy","unscheduleAllCallbacks"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Label, resources, Sprite, SpriteFrame, math, EventTouch, UITransform, Layers, rect, tween, Vec3, Color, Enum } from 'cc';\r\nimport { UIManager } from \"./UIManager\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n\r\n\r\ninterface ILevel {\r\n    rows: number;\r\n    cols: number;\r\n    time: number;\r\n    maxClicks: number;\r\n    penaltyTime: number;\r\n    hasFreeze: boolean;\r\n    hasSpinOut: boolean;\r\n}\r\n\r\n// Создаем список доступных анимаций\r\nenum VictoryEffect {\r\n    SPIN_WAVE,   // Вращательная волна\r\n    BOUNCE_WAVE, // Прыгающая волна\r\n    NONE         // Без анимации\r\n}\r\n// Регистрируем Enum для инспектора\r\nEnum(VictoryEffect);\r\n\r\n@ccclass('Game')\r\nexport class Game extends Component {\r\n    // Убедись, что в Инспекторе привязаны эти три Label!\r\n    @property({ type: Label }) public scoreLabel: Label | null = null;\r\n    @property({ type: Label }) public timerLabel: Label | null = null;\r\n    @property({ type: Label }) public stateLabel: Label | null = null;\r\n    @property({ type: Node }) public puzzleContainer: Node | null = null;\r\n    // Вместо путей текстом, давай сделаем массив картинок прямо в Инспекторе\r\n    @property([SpriteFrame]) public levelImages: SpriteFrame[] = [];\r\n\r\n    // Появится в инспекторе как выпадающий список!\r\n    @property({ type: VictoryEffect }) public victoryEffect: VictoryEffect = VictoryEffect.BOUNCE_WAVE;\r\n\r\n    @property public useConfetti: boolean = true;\r\n\r\n    @property(UIManager) public ui: UIManager = null!;\r\n\r\n    @property({ tooltip: \"Если включено, уровни меняются сами\" })\r\n    public autoNextLevel: boolean = true;\r\n\r\n\r\n\r\n    private levels: ILevel[] = [\r\n        { rows: 3, cols: 3, time: 60, maxClicks: 10, penaltyTime: 2, hasFreeze: false, hasSpinOut: false },\r\n        { rows: 4, cols: 4, time: 80, maxClicks: 6, penaltyTime: 5, hasFreeze: true, hasSpinOut: false },\r\n        { rows: 6, cols: 6, time: 1000, maxClicks: 5, penaltyTime: 10, hasFreeze: true, hasSpinOut: true }\r\n    ];\r\n\r\n    private currentLevelIdx: number = 0;\r\n    private currentTime: number = 0;\r\n    private isGameOver: boolean = false;\r\n    private score: number = 0;\r\n\r\n    onLoad() {\r\n        // this.startLevel(this.currentLevelIdx);\r\n    }\r\n\r\n    start() {\r\n        // ПРОВЕРКА: Если всё связано, игра сама включит режим игры\r\n        // Если хочешь начать с меню — замени на 'MENU'\r\n        if (this.ui) {\r\n            this.ui.showState('GAME');\r\n        }\r\n        this.startLevel(this.currentLevelIdx);\r\n    }\r\n\r\n    // Когда пазл собран, вызывай это:\r\n    public onWin() {\r\n        if (this.ui) this.ui.showState('VICTORY');\r\n    }\r\n\r\n    // Метод специально для кнопки \"Next\" или авто-перехода\r\n    // Внутри класса Game в Game.ts\r\n    public startNextLevel() {\r\n        this.currentLevelIdx++;\r\n        if (this.currentLevelIdx < this.levels.length) {\r\n            this.startLevel(this.currentLevelIdx);\r\n        } else {\r\n            // Если уровни кончились — в меню\r\n            this.ui.showState('MENU');\r\n            this.currentLevelIdx = 0;\r\n        }\r\n    }\r\n\r\n    startLevel(idx: number) {\r\n        const config = this.levels[idx];\r\n        this.currentTime = config.time;\r\n        this.isGameOver = true; // <--- ВАЖНО: блокируем клики здесь\r\n\r\n        // Сразу обновляем текст, чтобы игрок видел цифры до старта\r\n        if (this.timerLabel) this.timerLabel.string = \"Time: \" + this.currentTime;\r\n        if (this.scoreLabel) this.scoreLabel.string = \"Score: 0\";\r\n\r\n        if (this.stateLabel) this.stateLabel.string = \"\";\r\n        this.puzzleContainer?.removeAllChildren();\r\n\r\n        const image = this.levelImages[idx];\r\n        if (image) {\r\n            this.setupGrid(image, config);\r\n            this.startCountdown();\r\n        }\r\n    }\r\n\r\n    private countdownValue: number = 3;\r\n\r\n    startCountdown() {\r\n        if (!this.stateLabel) return;\r\n\r\n        this.unschedule(this.doCountdownTick); // Чистим старые циклы\r\n        this.unschedule(this._timer);          // Чистим старый таймер\r\n\r\n        this.countdownValue = 3;\r\n        this.isGameOver = true;                // КЛИКИ ЗАБЛОКИРОВАНЫ\r\n        this.stateLabel.node.active = true;\r\n\r\n        // Запускаем строго: 4 тика (3, 2, 1, GO) с интервалом в 1 сек\r\n        this.schedule(this.doCountdownTick, 1, 3, 0);\r\n        this.doCountdownTick(); // Первый тик (цифра 3) сразу\r\n    }\r\n\r\n    doCountdownTick() {\r\n        if (!this.stateLabel) return;\r\n\r\n        if (this.countdownValue > 0) {\r\n            this.stateLabel.string = this.countdownValue.toString();\r\n\r\n            // Твоя анимация пульсации\r\n            this.stateLabel.node.setScale(new Vec3(0.5, 0.5, 1));\r\n            tween(this.stateLabel.node)\r\n                .to(0.2, { scale: new Vec3(1.2, 1.2, 1) }, { easing: 'backOut' })\r\n                .start();\r\n\r\n            this.countdownValue--;\r\n        } else {\r\n            // ЭТОТ БЛОК СРАБОТАЕТ ТОЛЬКО ОДИН РАЗ ДЛЯ \"GO!\"\r\n            this.stateLabel.string = \"GO!\";\r\n            this.isGameOver = false; // ТЕПЕРЬ МОЖНО КЛИКАТЬ\r\n\r\n            this.unschedule(this._timer);\r\n            this.schedule(this._timer, 1); // ВКЛЮЧАЕМ ТАЙМЕР\r\n\r\n            // Прячем надпись \"GO!\" через полсекунды\r\n            this.scheduleOnce(() => {\r\n                if (this.stateLabel && this.stateLabel.string === \"GO!\") {\r\n                    this.stateLabel.string = \"\";\r\n                }\r\n            }, 0.5);\r\n\r\n            // Важно: останавливаем сам отсчет, чтобы он не зашел на второй круг\r\n            this.unschedule(this.doCountdownTick);\r\n        }\r\n    }\r\n\r\n    setupGrid(sprf: SpriteFrame, config: ILevel) {\r\n        this.isGameOver = true; // Запираем игру на замок, пока идет подготовка\r\n        const imgSize = sprf.originalSize;\r\n        const rectW = imgSize.width / config.cols;\r\n        const rectH = imgSize.height / config.rows;\r\n\r\n        for (let i = 0; i < config.rows; i++) {\r\n            for (let j = 0; j < config.cols; j++) {\r\n                const piece = new Node(`Piece_${i}_${j}`);\r\n                piece.layer = Layers.Enum.UI_2D;\r\n\r\n                const ui = piece.addComponent(UITransform);\r\n                ui.setContentSize(rectW, rectH);\r\n\r\n                const sprite = piece.addComponent(Sprite);\r\n                const frame = sprf.clone();\r\n                frame.rect = rect(j * rectW, i * rectH, rectW, rectH);\r\n                sprite.spriteFrame = frame;\r\n\r\n                // ВАЖНО: Добавляем строго в контейнер!\r\n                if (this.puzzleContainer) {\r\n                    this.puzzleContainer.addChild(piece);\r\n                }\r\n\r\n                const posX = j * rectW - imgSize.width / 2 + rectW / 2;\r\n                const posY = i * rectH - imgSize.height / 2 + rectH / 2;\r\n                piece.setPosition(posX, -posY, 0);\r\n\r\n                const angles = [0, 90, 180, 270];\r\n                piece.angle = angles[math.randomRangeInt(0, 4)];\r\n\r\n                piece['clickCount'] = 0;\r\n                piece['isLocked'] = false;\r\n\r\n                piece.on(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (this.isGameOver) return;\r\n\r\n        const target = event.target as Node;\r\n        const config = this.levels[this.currentLevelIdx];\r\n\r\n        // 1. БЛОКИРОВКА: Если деталь заморожена или заблокирована — выходим\r\n        if (target['isLocked'] || target['isFrozen']) {\r\n            console.log(\"Действие заблокировано: деталь заморожена\");\r\n            return;\r\n        }\r\n\r\n        target['clickCount']++;\r\n\r\n        // 2. ПРОВЕРКА ШТРАФА\r\n        if (target['clickCount'] > config.maxClicks) {\r\n            this.applyPenalty(target, config);\r\n            // Мы НЕ вызываем rotatePiece здесь, деталь просто замирает и синеет\r\n            return;\r\n        }\r\n\r\n        // 3. ВРАЩЕНИЕ (срабатывает, только если всё ок)\r\n        this.rotatePiece(target);\r\n    }\r\n\r\n    rotatePiece(target: Node) {\r\n        if (target['isRotating']) return;\r\n        target['isRotating'] = true;\r\n\r\n        const config = this.levels[this.currentLevelIdx];\r\n        let rotationCount = 1;\r\n\r\n        // Если на уровне включен Spin-Out, есть шанс 20%, что деталь крутанется сильнее\r\n        if (config.hasSpinOut && Math.random() < 0.2) {\r\n            rotationCount = Math.floor(Math.random() * 3) + 1;\r\n        }\r\n\r\n        let targetAngle = target.angle - (90 * rotationCount);\r\n\r\n        tween(target)\r\n            .to(0.2 * rotationCount, { angle: targetAngle }, { easing: 'sineOut' })\r\n            .call(() => {\r\n                target.angle = Math.round(target.angle) % 360;\r\n                target['isRotating'] = false;\r\n                this._score();\r\n            })\r\n            .start();\r\n    }\r\n\r\n    applyPenalty(target: Node, config: ILevel) {\r\n        if (this.isGameOver) return;\r\n\r\n        // 1. СТОП: Гасим старый таймер, чтобы он не тикнул в момент штрафа\r\n        this.unschedule(this._timer);\r\n\r\n        // 2. РАСЧЕТ: Отнимаем штраф\r\n        this.currentTime -= config.penaltyTime;\r\n\r\n        // 3. ПРОВЕРКА: Если ушли в минус или ноль\r\n        if (this.currentTime <= 0) {\r\n            this.game_over(\"OUT OF TIME!\");\r\n        }\r\n        else {\r\n            // Если еще живы, обновляем текст и запускаем таймер заново\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: \" + this.currentTime;\r\n            this.triggerPenaltyVisual(config.penaltyTime);\r\n            this.schedule(this._timer, 1);\r\n        }\r\n\r\n        target['clickCount'] = 0;\r\n        this.freezePiece(target);\r\n    }\r\n\r\n    freezePiece(target: Node) {\r\n        target['isFrozen'] = true;\r\n        const sprite = target.getComponent(Sprite);\r\n\r\n        if (sprite) {\r\n            // Включаем встроенный черно-белый режим\r\n            sprite.grayscale = true;\r\n        }\r\n\r\n        this.scheduleOnce(() => {\r\n            target['isFrozen'] = false;\r\n            if (sprite) {\r\n                // Выключаем и возвращаем цвета\r\n                sprite.grayscale = false;\r\n            }\r\n        }, 2);\r\n    }\r\n\r\n    _timer() {\r\n        if (this.isGameOver) return;\r\n\r\n        this.currentTime--;\r\n\r\n        // Проверка СРАЗУ после вычитания\r\n        if (this.currentTime <= 0) {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n            this.game_over(\"TIME IS UP!\"); // Метод, где ставится isGameOver = true\r\n            return;\r\n        }\r\n\r\n        if (this.timerLabel) {\r\n            this.timerLabel.string = \"Time: \" + this.currentTime;\r\n        }\r\n    }\r\n\r\n    _score() {\r\n        let correctPieces = 0;\r\n        if (this.puzzleContainer) {\r\n            // Считаем текущее количество правильно повернутых деталей\r\n            this.puzzleContainer.children.forEach(child => {\r\n                let angle = Math.round(child.angle) % 360;\r\n                if (Math.abs(angle) === 0 || Math.abs(angle) === 360) {\r\n                    correctPieces++;\r\n                }\r\n            });\r\n        }\r\n\r\n        this.score = correctPieces;\r\n\r\n        if (this.scoreLabel) {\r\n            this.scoreLabel.string = \"Score: \" + this.score;\r\n        }\r\n\r\n        // ОПРЕДЕЛЯЕМ ОБЩЕЕ КОЛИЧЕСТВО ДЕТАЛЕЙ\r\n        const config = this.levels[this.currentLevelIdx];\r\n        const totalPieces = config.rows * config.cols; // Вот решение ошибки!\r\n\r\n        // ПРОВЕРКА ПОБЕДЫ\r\n        if (this.score === totalPieces && !this.isGameOver) {\r\n            this.isGameOver = true;\r\n            this.unschedule(this._timer);\r\n\r\n            this.victoryAnimation();\r\n\r\n            // Задержка перед финальным экраном, чтобы успела проиграться анимация\r\n            this.scheduleOnce(() => {\r\n                this.game_over(\"VICTORY!\");\r\n            }, 1.2);\r\n        }\r\n    }\r\n\r\n    victoryAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        // Запускаем конфетти, если галочка стоит\r\n        if (this.useConfetti) {\r\n            this.spawnConfetti();\r\n        }\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            const delay = index * 0.05;\r\n\r\n            if (this.victoryEffect === VictoryEffect.SPIN_WAVE) {\r\n                // Анимация с вращением\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.2, { scale: new Vec3(1.1, 1.1, 1) })\r\n                        .by(0.4, { angle: 360 }, { easing: 'quartOut' })\r\n                        .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                        .start();\r\n                }, delay);\r\n\r\n            } else if (this.victoryEffect === VictoryEffect.BOUNCE_WAVE) {\r\n                // Анимация с прыжком (без вращения)\r\n                const originalPos = piece.position.clone();\r\n                const upPos = new Vec3(originalPos.x, originalPos.y + 40, originalPos.z);\r\n\r\n                this.scheduleOnce(() => {\r\n                    tween(piece)\r\n                        .to(0.15, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                        .to(0.15, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                        .start();\r\n                }, delay);\r\n            }\r\n        });\r\n    }\r\n    spawnConfetti() {\r\n        const colors = [Color.RED, Color.GREEN, Color.BLUE, Color.YELLOW, Color.CYAN, Color.MAGENTA];\r\n\r\n        // Берем текстуру от первого попавшегося кусочка пазла, чтобы не искать в ресурсах\r\n        const referenceSprite = this.puzzleContainer?.getComponentInChildren(Sprite)?.spriteFrame;\r\n\r\n        for (let i = 0; i < 40; i++) {\r\n            const particle = new Node(\"Confetti\");\r\n            particle.layer = Layers.Enum.UI_2D;\r\n\r\n            const ui = particle.addComponent(UITransform);\r\n            ui.setContentSize(20, 20);\r\n\r\n            const sprite = particle.addComponent(Sprite);\r\n            if (referenceSprite) {\r\n                sprite.spriteFrame = referenceSprite; // Даем картинку\r\n            }\r\n            sprite.color = colors[math.randomRangeInt(0, colors.length)];\r\n\r\n            // Добавляем в Canvas или прямо в Game Node, чтобы было ВЫШЕ пазлов\r\n            this.node.parent.addChild(particle);\r\n\r\n            // Устанавливаем Z-index повыше (для UI в Cocos 3.x это порядок в иерархии)\r\n            particle.setSiblingIndex(100);\r\n\r\n            particle.setPosition(0, 0, 0);\r\n\r\n            const destX = math.randomRange(-600, 600);\r\n            const destY = math.randomRange(-600, 600);\r\n            const duration = math.randomRange(0.8, 1.5);\r\n\r\n            tween(particle)\r\n                .to(duration, {\r\n                    position: new Vec3(destX, destY, 0),\r\n                    angle: math.randomRange(0, 360),\r\n                    scale: new Vec3(0.2, 0.2, 0.2)\r\n                }, { easing: 'circOut' })\r\n                .call(() => particle.destroy())\r\n                .start();\r\n        }\r\n    }\r\n\r\n    bounceWaveAnimation() {\r\n        if (!this.puzzleContainer) return;\r\n\r\n        const pieces = this.puzzleContainer.children;\r\n\r\n        pieces.forEach((piece, index) => {\r\n            // Сохраняем начальную позицию, чтобы деталь вернулась точно на место\r\n            const originalPos = piece.position.clone();\r\n            const upPos = new Vec3(originalPos.x, originalPos.y + 30, originalPos.z);\r\n\r\n            this.scheduleOnce(() => {\r\n                tween(piece)\r\n                    // 1. Прыжок вверх и легкое увеличение\r\n                    .to(0.2, { position: upPos, scale: new Vec3(1.1, 1.1, 1) }, { easing: 'sineOut' })\r\n                    // 2. Возвращение вниз с \"приземлением\"\r\n                    .to(0.2, { position: originalPos, scale: new Vec3(1, 1, 1) }, { easing: 'sineIn' })\r\n                    .start();\r\n            }, index * 0.05); // Та самая задержка для эффекта волны\r\n        });\r\n    }\r\n\r\n    game_over(reason: string = \"Game Over\") {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n\r\n        if (this.stateLabel) {\r\n            // УСТАНАВЛИВАЕМ БЕЛЫЙ ЦВЕТ (чтобы после красного штрафа Victory была белой)\r\n            this.stateLabel.color = Color.WHITE;\r\n\r\n            this.stateLabel.string = reason;\r\n            this.stateLabel.node.active = true;\r\n\r\n            // Твоя крутая анимация\r\n            this.stateLabel.node.setScale(new Vec3(0, 0, 0));\r\n            this.stateLabel.node.angle = -45;\r\n\r\n            tween(this.stateLabel.node)\r\n                .to(0.5, { scale: new Vec3(1.2, 1.2, 1), angle: 0 }, { easing: 'backOut' })\r\n                .to(0.2, { scale: new Vec3(1, 1, 1) })\r\n                .start();\r\n        }\r\n\r\n        // Если это проигрыш, обнуляем таймер. Если победа — оставляем как есть.\r\n        if (reason !== \"VICTORY!\") {\r\n            this.currentTime = 0;\r\n            if (this.timerLabel) this.timerLabel.string = \"Time: 0\";\r\n        }\r\n\r\n        this.stopGame();\r\n        /*\r\n        // ВОТ ЭТОТ БЛОК \"АВТОПИЛОТА\":\r\n        if (reason === \"VICTORY!\") {\r\n            this.ui.showState('VICTORY');\r\n            this.scheduleOnce(() => {\r\n                this.currentLevelIdx++; // Готовим следующий уровень\r\n\r\n                // Проверяем, есть ли у нас еще уровни в списке\r\n                if (this.currentLevelIdx < this.levels.length) {\r\n                    this.startLevel(this.currentLevelIdx);\r\n                    this.ui.showState('GAME');\r\n                } else {\r\n                    // Если уровни закончились\r\n                    if (this.stateLabel) this.stateLabel.string = \"YOU ARE THE CHAMPION!\";\r\n                    this.currentLevelIdx = 0; // Сбрасываем на начало на всякий случай\r\n                }\r\n            }, 4.0);\r\n        }\r\n        */\r\n        if (reason === \"VICTORY!\") {\r\n            this.ui.showState('VICTORY');\r\n            // Больше ничего не делаем. Ждем, пока игрок нажмет кнопку, \r\n            // которая вызовет UIManager -> onNextLevelBtnClick\r\n        }\r\n    }\r\n\r\n    stopGame() {\r\n        this.isGameOver = true;\r\n        this.unschedule(this._timer);\r\n        this.node.children.forEach(child => {\r\n            child.off(Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        });\r\n    }\r\n\r\n    triggerPenaltyVisual(penalty: number) {\r\n        if (!this.stateLabel) return;\r\n\r\n        // Показываем, сколько именно отняли\r\n        this.stateLabel.string = `-${penalty} SEC!`;\r\n        this.stateLabel.node.active = true;\r\n        const originalColor = this.stateLabel.color.clone();\r\n        this.stateLabel.color = Color.RED;\r\n\r\n        // Тряска или просто исчезновение\r\n        tween(this.stateLabel.node)\r\n            .to(0.1, { scale: new Vec3(1.2, 1.2, 1) })\r\n            .to(0.1, { scale: new Vec3(1, 1, 1) })\r\n            .delay(0.5)\r\n            .call(() => {\r\n                if (this.stateLabel) {\r\n                    this.stateLabel.string = \"\";\r\n                    this.stateLabel.color = originalColor;\r\n                }\r\n            })\r\n            .start();\r\n    }\r\n\r\n    onDestroy() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}"]}